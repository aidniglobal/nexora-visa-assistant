{% extends 'base.html' %}

{% block content %}
<h2>Admin - Inquiries</h2>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category=='error' else category }}">{{ message }}</div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="mb-3">
    <form method="GET" class="d-flex gap-2">
        <select name="status" class="form-select" style="width:auto;">
            <option value="">All</option>
            <option value="unresponded" {% if filter_status=='unresponded' %}selected{% endif %}>Unresponded</option>
            <option value="closed" {% if filter_status=='closed' %}selected{% endif %}>Closed</option>
        </select>
        <button class="btn btn-secondary" type="submit">Filter</button>
    </form>
</div>

<table class="table table-striped">
    <thead>
        <tr><th>ID</th><th>Name</th><th>Email</th><th>Message</th><th>Created</th><th>Status</th><th>Response</th><th>Actions</th></tr>
    </thead>
    <tbody>
        {% for q in inquiries %}
        <tr>
            <td>{{ q.id }}</td>
            <td>{{ q.name }}</td>
            <td>{{ q.email }}</td>
            <td>{{ q.message|truncate(80) }}</td>
            <td>{{ q.created_at.strftime('%Y-%m-%d %H:%M') if q.created_at }}</td>
            <td>{{ q.status }}</td>
            <td>{% if q.response %}Yes ({{ q.responded_at.strftime('%Y-%m-%d') }}){% else %}No{% endif %}</td>
            <td>
                <a href="{{ url_for('admin_respond_inquiry', inq_id=q.id) }}" class="btn btn-sm btn-primary">Respond</a>
                <form method="POST" action="{{ url_for('admin_quick_reply', inq_id=q.id) }}" style="display:inline;" class="quick-reply-form" data-id="{{ q.id }}">
                    <button type="button" class="btn btn-sm btn-outline-success quick-reply-btn">Quick Reply</button>
                </form>
                <form method="POST" action="{{ url_for('admin_close_inquiry', inq_id=q.id) }}" style="display:inline;" onsubmit="return confirm('Close this inquiry?');">
                    <button type="submit" class="btn btn-sm btn-outline-danger">Close</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<nav aria-label="Page navigation">
  <ul class="pagination">
    {% if pagination.has_prev %}
      <li class="page-item"><a class="page-link" href="?page={{ pagination.prev_num }}{% if filter_status %}&status={{ filter_status }}{% endif %}">Previous</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Previous</span></li>
    {% endif %}

    <li class="page-item disabled"><span class="page-link">Page {{ pagination.page }} of {{ pagination.pages or 1 }}</span></li>

    {% if pagination.has_next %}
      <li class="page-item"><a class="page-link" href="?page={{ pagination.next_num }}{% if filter_status %}&status={{ filter_status }}{% endif %}">Next</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Next</span></li>
    {% endif %}
  </ul>
</nav>

<!-- Confirmation Modal -->
<div class="modal fade" id="quickReplyModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Quick Reply</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Send a templated quick reply to this inquiry?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmQuickReply">Send Quick Reply</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  let targetForm = null
  document.querySelectorAll('.quick-reply-btn').forEach(btn => {
    btn.addEventListener('click', (e)=>{
      targetForm = e.target.closest('form')
      const modal = new bootstrap.Modal(document.getElementById('quickReplyModal'))
      modal.show()
    })
  })
  document.getElementById('confirmQuickReply').addEventListener('click', ()=>{
    if (targetForm) targetForm.submit()
  })
})()
</script>
